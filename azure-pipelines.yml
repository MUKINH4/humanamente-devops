trigger:
  branches:
    include:
      - main

pool:
  vmImage: "ubuntu-latest"

variables:
  - group: humanamente-variables
  - name: GRADLE_USER_HOME
    value: $(Pipeline.Workspace)/.gradle
  - name: TAG
    value: "$(Build.BuildId)"
  - name: ACR_NAME
    value: "humanamente"
  - name: IMAGE_NAME
    value: "humanamente"
  - name: AZURE_SERVICE_CONNECTION
    value: "HumanamenteAzureConnection"
  - name: RESOURCE_GROUP
    value: "rg-humanamente"
  - name: AZURE_LOCATION
    value: "eastus"

stages:
  - stage: Build
    displayName: CI (build & tests)
    jobs:
      - job: gradleBuild
        pool:
          vmImage: ubuntu-latest

        steps:
          - checkout: self
            displayName: "Checkout Repository"

          - script: chmod +x ./gradlew
            displayName: "Make gradlew executable"

          - task: Cache@2
            inputs:
              key: 'gradle | "$(Agent.OS)" | **/*.gradle*'
              restoreKeys: |
                gradle | "$(Agent.OS)"
                gradle
              path: $(GRADLE_USER_HOME)
            displayName: Configure gradle caching

          - task: Gradle@4
            inputs:
              gradleWrapperFile: "gradlew"
              tasks: "build"
              options: "--build-cache -Dspring.profiles.active=test"
              publishJUnitResults: true
              testResultsFiles: "**/TEST-*.xml"
              javaHomeOption: "JDKVersion"
              sonarQubeRunAnalysis: false
            continueOnError: true

          - script: ./gradlew --stop
            displayName: Gradlew stop

          - task: CopyFiles@2
            displayName: "Copy Files to artifact staging directory"
            inputs:
              SourceFolder: "$(System.DefaultWorkingDirectory)"
              Contents: "**/build/libs/*SNAPSHOT.jar"
              TargetFolder: $(Build.ArtifactStagingDirectory)

          - publish: $(Build.ArtifactStagingDirectory)
            artifact: humanamenteApp

      - job: BuildAndPushImage
        displayName: Build and push docker image
        pool:
          vmImage: ubuntu-latest
        dependsOn: gradleBuild
        condition: succeeded()
        steps:
          - script: chmod +x ./gradlew
            displayName: "Make gradlew executable"

          - task: Docker@2
            displayName: "Login to ACR"
            inputs:
              command: login
              containerRegistry: humanamente-registry

          - task: Docker@2
            displayName: "Build and push image to ACR"
            inputs:
              command: buildAndPush
              containerRegistry: humanamente-registry
              repository: $(IMAGE_NAME)
              dockerfile: Dockerfile
              buildContext: "$(System.DefaultWorkingDirectory)"
              tags: |
                latest
                $(Build.BuildId)

  # =============================================
  # STAGE 2: CD - Deploy
  # =============================================
  - stage: Deploy
    displayName: "CD - Deploy to Azure Container Instances"
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: Deploy
        displayName: "Deploy App to ACI"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: none

          - task: AzureCLI@2
            displayName: "Deploy Application to ACI"
            inputs:
              azureSubscription: "$(AZURE_SERVICE_CONNECTION)"
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -euo pipefail

                echo "Using resource group: $(RESOURCE_GROUP) in $(AZURE_LOCATION)"

                # Obter credenciais do ACR
                ACR_USERNAME=$(az acr credential show -n $(ACR_NAME) --query username -o tsv)
                ACR_PASSWORD=$(az acr credential show -n $(ACR_NAME) --query "passwords[0].value" -o tsv)

                # Nome do container e DNS
                APP_CONTAINER_NAME="aci-app-humanamente"
                APP_DNS_LABEL="aci-app-humanamente"

                # Excluir container anterior (para liberar DNS)
                echo "Cleaning up previous container if it exists..."
                az container delete --resource-group "$(RESOURCE_GROUP)" --name "$APP_CONTAINER_NAME" --yes || true
                sleep 10

                # Usar a tag do BuildId para garantir que a imagem existe
                IMAGE_TAG="$(Build.BuildId)"
                APP_IMAGE="$(ACR_NAME).azurecr.io/$(IMAGE_NAME):$IMAGE_TAG"
                echo "Deploying application container: $APP_CONTAINER_NAME"
                echo "Image: $APP_IMAGE"

                az container create \
                  --resource-group "$(RESOURCE_GROUP)" \
                  --name "$APP_CONTAINER_NAME" \
                  --image "$APP_IMAGE" \
                  --cpu 1 --memory 1.5 \
                  --registry-login-server "$(ACR_NAME).azurecr.io" \
                  --registry-username "$ACR_USERNAME" \
                  --registry-password "$ACR_PASSWORD" \
                  --environment-variables \
                    SPRING_DATASOURCE_URL="$(SPRING_DATASOURCE_URL)" \
                    SPRING_DATASOURCE_USERNAME="$(POSTGRES_USER)" \
                    SPRING_DATASOURCE_PASSWORD="$(POSTGRES_PASSWORD)" \
                    SPRING_JPA_HIBERNATE_DDL_AUTO=update \
                    SPRING_FLYWAY_ENABLED=true \
                    SPRING_FLYWAY_BASELINE_ON_MIGRATE=true \
                    GROQ_API_KEY="$(GROQ_API_KEY)" \
                    SPRING_RABBITMQ_HOST="$(SPRING_RABBITMQ_HOST)" \
                    SPRING_RABBITMQ_PORT="$(SPRING_RABBITMQ_PORT)" \
                    SPRING_RABBITMQ_USERNAME="$(SPRING_RABBITMQ_USERNAME)" \
                    SPRING_RABBITMQ_PASSWORD="$(SPRING_RABBITMQ_PASSWORD)" \
                    SPRING_RABBITMQ_VIRTUAL_HOST="$(SPRING_RABBITMQ_VIRTUAL_HOST)" \
                    SPRING_RABBITMQ_SSL_ENABLED="$(SPRING_RABBITMQ_SSL_ENABLED)" \
                  --ports 8080 \
                  --os-type Linux \
                  --dns-name-label "$APP_DNS_LABEL" \
                  --location "$(AZURE_LOCATION)" \
                  --restart-policy never

                # Aguardar a aplica√ß√£o iniciar
                echo "‚è≥ Aguardando a aplica√ß√£o iniciar..."
                sleep 60

                # Verificar se a aplica√ß√£o est√° rodando
                APP_FQDN=$(az container show --resource-group $(RESOURCE_GROUP) --name "$APP_CONTAINER_NAME" --query ipAddress.fqdn -o tsv)
                APP_URL="http://$APP_FQDN:8080"

                echo "‚úÖ Deploy conclu√≠do!"
                echo "üöÄ Aplica√ß√£o: $APP_URL"
                echo "üîë Login: admin / admin123"
                echo "üìã Para verificar logs: az container logs --resource-group $(RESOURCE_GROUP) --name $APP_CONTAINER_NAME"
